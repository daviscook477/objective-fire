<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/factory-extender.js - objective-fire</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="objective-fire" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/FactoryExtender.html">FactoryExtender</a></li>
                                <li><a href="../classes/FireObject.html">FireObject</a></li>
                                <li><a href="../classes/ObjectArray.html">ObjectArray</a></li>
                                <li><a href="../classes/ObjectArrayProperty.html">ObjectArrayProperty</a></li>
                                <li><a href="../classes/ObjectClass.html">ObjectClass</a></li>
                                <li><a href="../classes/ObjectiveFire.html">ObjectiveFire</a></li>
                                <li><a href="../classes/ObjectProperty.html">ObjectProperty</a></li>
                                <li><a href="../classes/PrimitiveProperty.html">PrimitiveProperty</a></li>
                                <li><a href="../classes/Properties.html">Properties</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/factory-extender.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
//TODO: make this work, currently it&#x27;s totally broken
angular.module(&#x27;objective-fire&#x27;)
.factory(&#x27;FactoryExtender&#x27;, function($FirebaseObject, $firebase, $q, ObjectArray) {
  /**
  Helper class that creates extended AngularFire factories
  @class FactoryExtender
  @static
  */
  return {
    /**
    Creates an AngularFire factory that makes of objects of a specific class from a specific Firebase
    @method createFactory
    @param objectClass {ObjectClass} The class of object the factory will produce
    @param rootRef Firebase object that is the root of the Firebase
    @param objFire {ObjectiveFire} References to the ObjectiveFire that made this FireObject
    @return AngularFire factory that produces objects of the class objectClass
    */
    createFactory: function(objectClass, rootRef, objFire) {
      var template = {};
      var properties = objectClass.properties;
      var pps = properties.primitive;
      var ops = properties.objectP;
      var aops = properties.arrayP;
      var methods = objectClass.objectMethods;
      for (param in methods) { // add the methods to the template for the AngularFire factory
        template[param] = methods[param];
      }
      // not sure how to document this with yuidoc - just use single *
      /*
      Method used to load ObjectProperty and ObjectArrayProperty
      @method $load
      @param name {String} The name of the property to load
      @return promise that resolves to the object
      */
      template.$load = function(name) {
        var deffered = $q.defer();
        this._doLoad[name] = true; // require that the property is loaded
        if (this._loaded) {

        } else { // if we haven&#x27;t loaded, it will be loaded when the object is loaded
          this.$loaded().then(function(self) {

          });
        }
        return deffered.promise;
      }
    }
  }
})
;


angular.module(&#x27;objective-fire&#x27;)
.factory(&#x27;FactoryExtender&#x27;, function($FirebaseObject, $firebase, $q, PointerArray) {
  return {
    // creates an extended angularjs factory
    createFactory: function(schema, rootRef, ObjectFire) {

      // get the properties from the schema
      var properties = schema.getProperties();
      var normalP = properties.getNormalProperties();
      var objectP = properties.getPointerObjectProperties();
      var arrayP = properties.getPointerArrayProperties();
      var dataP = properties.getPointerDataProperties();

      // get the lists of the three types of properties from the schema
      var properties = schema.getDataProperties();
      var pointersData = schema.getPointerDataProperties();
      var pointersList = schema.getPointerListProperties();

      // extend the factory and return the factory
      return $FirebaseObject.$extendFactory({

        //TODO: load should do something such that it doesn&#x27;t load the object and then $$update loads the object


        // this method instructs the object to load its pointer at name (there is no reason to use this with a normal property)
        load: function(name) {
          this._doLoad[name] = true; // we should load this (this property is checked in $$updated)

          // if we didn&#x27;t manually load the property now, we&#x27;d have to wait for a change in the data on firebase for it to load- that is not the intended behaviour

          // force it to load - return what was loaded in a promise
          var deffered = $q.defer();
          if (name in pointersData) { // if this is a pointerData

            // this section of code loads the object if it is a pointer to data
            this.$loaded().then(function(self) {
              var classOfObj = pointersData[name].object; // figure out which class of object we need to create
              self[name] = ObjectFire.getObjectClass(classOfObj).instance(self.pointers[name]);
              deffered.resolve(self[name]);
            });
          } else if (name in pointersList) {
            console.log(&quot;loading the &quot; + name);
            this.$loaded().then(function(self) {
              var classOfList = pointersList[name].object; // figure out which class to make the array
              var theClass = ObjectFire.getObjectClass(classOfList);
              var ref = rootRef.child(schema.getLocation()).child(self.$id).child(&quot;pointers&quot;).child(name);//.child(uh to somewhere this must lead)
              self[name] = new PointerArray(ref, theClass);
              deffered.resolve(self[name]);
            });
            // this section of code loads the object if it is a pointer list
            //TODO: implement loading and checking lists
          } else { // not a pointer

            // so here - the thing was not a pointer, in this case we&#x27;ll just return whatever they wanted off of this object after its $loaded
            this.$loaded().then(function(self) {
              deffered.resolve(self[name]); // it wasn&#x27;t a pointer so just resole it with whatever the hell is here
            })
          }
          return deffered.promise; // return the promise
        },

        // now we override the angularfire implementatation of methods in order to make it work with pointers
        $$updated: function(snapshot) {
          var newData = snapshot.val();
          var changed = false;
          //this method is going to get complicated if I want it to work right...


          //TODO: iterate through each property in each list of properties and add the property from the data snapshot to the correct locaiton on this object

          // &lt;========== HERE LIES OLDE CODE =======&gt;

          // check for changes in the pointers and update the pointers and respective objects on this
          // set &#x27;chhanged&#x27; to true if something changes
          for (param in pointersData) {
            console.log(&quot;this is a pointer: &quot; + param);
            if (this._doLoad[param]) { // if we should load this property
              console.log(&quot;we are going to load it&quot;);
              //temp
              var classOfObj = pointersData[param].object;
              console.log(&quot;this is the class we found for it: &quot; + JSON.stringify(classOfObj));
              newData[param] = ObjectFire.getObjectClass(classOfObj).instance(newData.pointers[param]);
            }
          }

          for (param in pointersList) {
            console.log(&quot;this is a pointer list: &quot; + param)
            if (this._doLoad[param]) {
              console.log(&quot;we are going to load it&quot;);
              var classOfList = pointersList[param].object;
              console.log(&quot;this is the class we found for it: &quot; + JSON.stringify(classOfList));
              var theClass = ObjectFire.getObjectClass(classOfList);
              var ref = rootRef.child(schema.getLocation()).child(this.$id).child(&quot;pointers&quot;).child(param);//.child(uh to somewhere this must lead)
              console.log(&quot;the location &quot; + param + &quot; is being set to a pointer array&quot;);
              newData[param] = new PointerArray(ref, theClass);
            }
          }

          // check for changes in normal data in the snapshot and update that here
          // change the &#x27;changed&#x27; variable to true if anything changed

          //TEMP:
          changed = true;
          for (param in newData) {
            this[param] = newData[param];
          }

          // return if the data was changed
          return changed;

          // &lt;======= HERE ENDS OLD CODE ======&gt;
        }
      });
    }
  }

});

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
