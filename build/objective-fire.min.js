angular.module("objective-fire",["firebase"]).factory("ObjectiveFire",["FireObject",function(a){function b(a){return!this instanceof b?new b(a):(this.ref=a,void(this.objects={}))}return b.prototype={registerObjectClass:function(b){return this.objects[b.name]=new a(b,this.ref,this),this},getObjectClass:function(a){return this.objects[a]}},b}]),angular.module("objective-fire").factory("Factories",["$firebaseObject","$firebaseArray","$q",function(a,b,c){var d={objectFactory:function(b,e,f){return a.$extend({_objectClass:b,_rootRef:e,_objFire:f,$load:function(a){var d=this._objectClass.properties,g=(d.primitive,d.objectP),h=d.arrayP,i=c.defer();if("string"!=typeof a)throw"name must be of type string";if(this._doLoad[a])i.resolve(this[a]);else{for(var j=void 0,k="",l=0;l<g.length;l++)if(g[l].name===a){j=g[l],k="op";break}for(var l=0;l<h.length;l++)if(h[l].name===a){j=h[l],k="oap";break}if(this._doLoad[a]=!0,this._loaded){if("op"===k){var m=j.objectClassName,n=f.getObjectClass(m),o=n.instance(this[a]);this[a]=o,this._isLoaded[a]=!0,i.resolve(this[a])}else if("oap"===k){var m=j.objectClassName,n=f.getObjectClass(m),p=new ObjectArray(e.child(b.name).child(this.$id).child(a),n);this[a]=p,this._isLoaded[a]=!0,i.resolve(this[a])}}else this.$loaded().then(function(c){if(!c._isLoaded[a])if("op"===k){var d=j.objectClassName,g=f.getObjectClass(d),h=g.instance(c[a]);c[a]=h}else if("oap"===k){var d=j.objectClassName,g=f.getObjectClass(d),l=new ObjectArray(e.child(b.name).child(c.$id).child(a),g);c[a]=l}c._isLoaded[a]=!0,i.resolve(c[a])})}return i.promise},$toJSON:function(a){for(var b=this._objectClass.properties,c=b.primitive,d=b.objectP,e=b.arrayP,f={},g=0;g<c.length;g++){var h=c[g].name;f[h]=a[h]}for(var g=0;g<d.length;g++){var h=d[g].name;f[h]="object"==typeof a[h]?a[h].$id:a[h]}for(var g=0;g<e.length;g++){var h=e[g].name;if("object"==typeof a[h]){f[h]=[];for(var i=0;i<a[h].length;i++)f[h][i]=a[h][i].$id}else f[h]=a[h]}for(var j in f)void 0===f[j]&&(f[j]=null);return f},$fromJSON:function(a){var b=this._objectClass.properties,c=b.primitive,e=b.objectP,f=b.arrayP,g=a.val();null===g&&(g={});for(var h={},i=0;i<c.length;i++){var j=c[i].name;h[j]=g[j]}for(var i=0;i<e.length;i++){var j=e[i].name;if(this._doLoad[j])if(this[j]&&this[j].$id===g[j])h[j]=this[j];else{var k=e[i].objectClassName,l=this._objFire.getObjectClass(k),m=l.instance(g[j]);this._isLoaded[j]=!0,h[j]=m}else h[j]=g[j]}for(var i=0;i<f.length;i++){var j=f[i].name;if(this._doLoad[j])if(this._isLoaded[j])h=this[j];else{var k=f[i].objectClassName,l=this._objFire.getObjectClass(k),n=d.arrayFactory(l,this._rootRef,this._objFire),o=new n(this._rootRef.child(this._objectClass.name).child(this.$id).child(j));this._isLoaded[j]=!0,h[j]=o}else h[j]=g[j]}return h}})},arrayFactory:function(a,c,d){return b.$extend({_fireObject:a,_rootRef:c,_objFire:d,$toJSON:function(a){return a.$id},$fromJSON:function(a){var b=this._fireObject.instance(a.val());return b}})}};return d}]),angular.module("objective-fire").factory("FireObject",["Factories",function(a){function b(b,c,d){this.objectClass=b,this.rootRef=c,this.objFire=d,this.Factory=a.objectFactory(b,c,d)}return b.prototype["new"]=function(){var a=this.rootRef.child(this.objectClass.name).push(),b=new this.Factory(a);if(b._loaded=!1,b.$loaded().then(function(){b._loaded=!0}),b._isLoaded={},b._doLoad={},null===this.objectClass.objectConstructor||"function"!=typeof this.objectClass.objectConstructor)throw"new may only be called for classes that have constructors";this.objectClass.objectConstructor.apply(b,arguments);for(var c=this.objectClass.properties,d=c.objectP,e=c.arrayP,f=0;f<d.length;f++){var g=d[f].name;g in b&&(b._isLoaded[g]=!0,b._doLoad[g]=!0)}for(var f=0;f<e.length;f++){var g=e[f].name;g in b&&(b._isLoaded[g]=!0,b._doLoad[g]=!0)}return b.$save(),b},b.prototype.instance=function(a){var b=this.rootRef.child(this.objectClass.name).child(a),c=new this.Factory(b);return c._loaded=!1,c.$loaded().then(function(){c._loaded=!0}),c._isLoaded={},c._doLoad={},c},b}]),angular.module("objective-fire").factory("ObjectArray",["$firebaseArray",function(a){var b=function(b){return a.$extend({$$added:function(a){return b.instance(a.val())},$$updated:function(a){var c=!1,d=this.$getRecord(a.val()),e=b.instance(a.val());return angular.equals(d,e)||(change=!0),c}})};return function(a,c){var d=new b(c);return d}}]),angular.module("objective-fire").factory("ObjectClass",function(){function a(b,c,d,e){if(!this instanceof a)return new a(b,c,d,e);if("string"!=typeof b)throw"name must be of type string";if("function"!=typeof c&&null!==c)throw"objectConstructor must be of type function or null";if("object"!=typeof d&&null!==d)throw"objectMethods must be of type object or null";if("object"!=typeof e&&null!==e)throw"properties must be of type object or null";this.name=b,this.objectConstructor=c,this.objectMethods=d,this.properties=e}return a}),angular.module("objective-fire").factory("ObjectProperty",function(){function a(b,c){if(!this instanceof a)return new a(b,c);if("string"!=typeof b)throw"name must be of type string";this.name=b,this.objectClassName=c}return a}).factory("ObjectArrayProperty",function(){function a(b,c){if(!this instanceof a)return new a(b,c);if("string"!=typeof b)throw"name must be of type string";this.name=b,this.objectClassName=c}return a}).factory("PrimitiveProperty",function(){function a(b){if(!this instanceof a)return new a(b);if("string"!=typeof b)throw"name must be of type string";this.name=b}return a}).factory("Properties",["PrimitiveProperty","ObjectProperty","ObjectArrayProperty",function(a,b,c){function d(){return!this instanceof d?new d:(this.primitive=[],this.objectP=[],void(this.arrayP=[]))}return d.prototype={addProperty:function(d){if(d instanceof a)this.primitive.push(d);else if(d instanceof b)this.objectP.push(d);else{if(!(d instanceof c))throw"property must be of type PrimitiveProperty || ObjectProperty || ObjectArrayProperty";this.arrayP.push(d)}return this},addPrimitiveProperty:function(b){this.primitive.push(new a(b))},addObjectProperty:function(a,c){this.objectP.push(new b(a,c))},addObjectArrayProperty:function(a,b){this.arrayP.push(new c(a,b))}},d}]);