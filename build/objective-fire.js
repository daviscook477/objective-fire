angular.module("objective-fire").factory("FactoryExtender",["$FirebaseObject","$firebase","$q","ObjectArray",function($FirebaseObject,$firebase,$q,ObjectArray){return{createFactory:function(objectClass,rootRef,objFire){var template={},properties=objectClass.properties,pps=properties.primitive,ops=properties.objectP,oaps=properties.arrayP,methods=objectClass.objectMethods;for(param in methods)template[param]=methods[param];return template.$load=function(name){var deffered=$q.defer();if(this._doLoad[name])deffered.resolve(this[name]);else{for(var property=void 0,kind="",i=0;i<ops.length;i++)if(ops[i].name===name){property=ops[i],kind="op";break}for(var i=0;i<oaps.length;i++)if(oaps[i].name===name){property=oaps[i],kind="oap";break}if(this._doLoad[name]=!0,this._loaded){if("op"===kind){var objectClassName=property.objectClassName,objectClass2=objFire.getObjectClass(objectClassName),obj=objectClass2.instance(this[name]);this[name]=obj,this._isLoaded[name]=!0,deffered.resolve(this[name])}else if("oap"===kind){var objectClassName=property.objectClassName,objectClass2=objFire.getObjectClass(objectClassName),arr=new ObjectArray(rootRef.child(objectClass.name).child(this.$id).child(name),objectClass2);this[name]=arr,this._isLoaded[name]=!0,deffered.resolve(this[name])}}else this.$loaded().then(function(self){if(!self._isLoaded[name])if("op"===kind){var objectClassName=property.objectClassName,objectClass2=objFire.getObjectClass(objectClassName),obj=objectClass2.instance(self[name]);self[name]=obj}else if("oap"===kind){var objectClassName=property.objectClassName,objectClass2=objFire.getObjectClass(objectClassName),arr=new ObjectArray(rootRef.child(objectClass.name).child(self.$id).child(name),objectClass2);self[name]=arr}self._isLoaded[name]=!0,deffered.resolve(self[name])})}return deffered.promise},template.$$updated=function(snapshot){for(var changed=!1,data=snapshot.val(),i=0;i<pps.length;i++){var name=pps[i].name;data[name]!==this[name]&&(changed=!0),this[name]=data[name]}for(var i=0;i<ops.length;i++){var name=ops[i].name;if(this._doLoad[name]){var objectClassName=ops[i].objectClassName,objectClass2=objFire.getObjectClass(objectClassName),obj=objectClass2.instance(data[name]);angular.equals(obj,this[name])||(changed=!0),this._isLoaded[name]=!0,this[name]=obj}else this[name]=data[name]}for(var i=0;i<oaps.length;i++){var name=oaps[i].name;if(this._doLoad[name]){var objectClassName=oaps[i].objectClassName,objectClass2=objFire.getObjectClass(objectClassName),arr=new ObjectArray(rootRef.child(objectClass.name).child(this.$id).child(name),objectClass2);angular.equals(arr,this[name])||(changed=!0),this._isLoaded[name]=!0,this[name]=arr}else this[name]=data[name]}return changed},template.$save=function(){for(var data={},i=0;i<pps.length;i++){var name=pps[i].name;data[name]=this[name]}for(var i=0;i<ops.length;i++){var name=ops[i].name;data[name]="object"==typeof this[name]?this[name].$id:this[name]}for(var i=0;i<oaps.length;i++){var name=oaps[i].name;if("object"==typeof this[name]){data[name]=[];for(var j=0;j<oaps[i].length;j++)data[name][j]=oaps[i][j]}else data[name]=this[name]}for(param in data)void 0===data[param]&&(data[param]=null);rootRef.child(objectClass.name).child(this.$id).set(data)},$FirebaseObject.$extendFactory(template)}}}]),angular.module("objective-fire").factory("FireObject",["$firebase","FactoryExtender",function($firebase,FactoryExtender){function FireObject(objectClass,rootRef,objFire){this.objectClass=objectClass,this.rootRef=rootRef,this.objFire=objFire,this.factory=FactoryExtender.createFactory(this.objectClass,this.rootRef,this.objFire)}return FireObject.prototype["new"]=function(){var ref=this.rootRef.child(this.objectClass.name).push(),sync=$firebase(ref,{objectFactory:this.factory}),obj=sync.$asObject();obj._loaded=!1,obj.$loaded().then(function(){obj._loaded=!0}),obj._isLoaded={},obj._doLoad={},obj.pointers={},null!=this.objectClass.objectConstructor&&this.objectClass.objectConstructor.apply(obj,arguments);for(var properties=this.objectClass.properties,ops=properties.objectP,i=(properties.arrayP,0);i<ops.length;i++){var name=ops[i].name;name in obj&&(obj._isLoaded[name]=!0,obj._doLoad[name]=!0)}return obj.$save(),obj},FireObject.prototype.instance=function(id){var ref=this.rootRef.child(this.objectClass.name).child(id),sync=$firebase(ref,{objectFactory:this.factory}),obj=sync.$asObject();return obj._loaded=!1,obj.$loaded().then(function(){obj._loaded=!0}),obj._isLoaded={},obj._doLoad={},obj.pointers={},obj},FireObject}]),angular.module("objective-fire").factory("ObjectArray",["$FirebaseArray","$firebase",function($FirebaseArray,$firebase){var getFactory=function(fireObject){return $FirebaseArray.$extendFactory({$$added:function(snapshot){return fireObject.instance(snapshot.val())},$$updated:function(snapshot){var changed=!1,curO=this.$getRecord(snapshot.val()),newO=fireObject.instance(snapshot.val());return angular.equals(curO,newO)||(change=!0),changed}})};return function(ref,fireObject){var sync=$firebase(ref,{arrayFactory:getFactory(fireObject)}),obj=sync.$asArray();return obj}}]),angular.module("objective-fire").factory("ObjectClass",function(){function ObjectClass(name,objectConstructor,objectMethods,properties){return!this instanceof ObjectClass?new ObjectClass(name,objectConstructor,objectMethods,properties):(this.name=name,this.objectConstructor=objectConstructor,this.objectMethods=objectMethods,void(this.properties=properties))}return ObjectClass}),angular.module("objective-fire",["firebase"]).factory("ObjectiveFire",["FireObject",function(FireObject){function ObjectiveFire(ref){return!this instanceof ObjectiveFire?new ObjectiveFire(ref):(this.ref=ref,void(this.objects={}))}return ObjectiveFire.prototype={registerObjectClass:function(objectClass){return this.objects[objectClass.name]=new FireObject(objectClass,this.ref,this),this},getObjectClass:function(name){return this.objects[name]}},ObjectiveFire}]),angular.module("objective-fire").factory("ObjectProperty",function(){function ObjectProperty(name,objectClassName){return!this instanceof ObjectProperty?new ObjectProperty(name,objectClassName):(this.name=name,void(this.objectClassName=objectClassName))}return ObjectProperty}).factory("ObjectArrayProperty",function(){function ObjectArrayProperty(name,objectClassName){return!this instanceof ObjectProperty?new ObjectArrayProperty(name,objectClassName):(this.name=name,void(this.objectClassName=objectClassName))}return ObjectArrayProperty}).factory("PrimitiveProperty",function(){function PrimitiveProperty(name){return!this instanceof PrimitiveProperty?new PrimitiveProperty(name):void(this.name=name)}return PrimitiveProperty}).factory("Properties",["PrimitiveProperty","ObjectProperty","ObjectArrayProperty",function(PrimitiveProperty,ObjectProperty,ObjectArrayProperty){function Properties(){return!this instanceof Properties?new Properties:(this.primitive=[],this.objectP=[],void(this.arrayP=[]))}return Properties.prototype={addProperty:function(property){return property instanceof PrimitiveProperty?this.primitive.push(property):property instanceof ObjectProperty?this.objectP.push(property):property instanceof ObjectArrayProperty&&this.arrayP.push(property),this}},Properties}]);